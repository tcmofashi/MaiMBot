# MaiMBot API服务器设计指导

## 概述

MaiMBot API服务器是一个基于FastAPI的多租户AI聊天机器人配置和管理系统，作为内部服务提供租户管理、Agent配置、API密钥管理和聊天功能。本服务设计为无需认证的内部服务，所有接口都可直接访问，专注于配置管理的核心功能。

## 核心设计原则

### 1. 多租户隔离架构
- **层级关系**: Tenant (一级) -> Agent (二级) -> API Keys (三级)
- **四维隔离**: Tenant + Agent + Chat Stream + Platform
- **数据分离**: 不同租户间100%数据隔离
- **实例管理**: 每租户独立组件实例
- **安全边界**: 严格的租户权限控制

**层级约束**:
- Agent必须属于特定租户，不能独立存在
- API密钥必须属于特定租户和特定Agent
- 查询Agent和API密钥列表时，tenant_id为必需参数

### 2. RESTful API设计
- **资源导向**: 清晰的资源层次结构
- **HTTP语义**: 正确使用HTTP方法和状态码
- **统一响应**: 标准化的响应格式
- **版本控制**: API版本化管理 (`/api/v2/`)

### 3. 内部服务架构
- **无需认证**: 所有接口都无需身份验证，作为内部服务使用
- **网络隔离**: 通过网络层面的访问控制确保服务安全
- **数据加密**: 敏感数据加密存储
- **输入验证**: 严格的参数验证和清理
- **日志记录**: 完整的操作日志记录
- **监控告警**: 服务状态监控和异常告警

## 技术架构

### 核心技术栈
- **Web框架**: FastAPI
- **数据库**: MySQL (主数据库)
- **缓存**: Redis (会话和缓存)
- **认证**: JWT + bcrypt
- **ORM**: Peewee
- **部署**: Docker + Nginx

### 项目结构
```
src/api/
├── main.py                 # 主路由和应用入口
├── routes/                 # API路由模块
│   ├── auth_api_v2.py     # API密钥认证和验证（无需认证）
│   ├── tenant_api_v2.py   # 租户管理API（无需认证）
│   ├── agent_api_v2.py    # Agent管理API（无需认证）
│   ├── api_key_api_v2.py  # API密钥管理（无需认证）
│   └── chat_api_v2.py     # 聊天功能API（无需认证）
├── utils/                  # 工具模块
│   └── response.py        # 统一响应格式
└── init_agent_templates.py # 初始化Agent模板
```

### 数据库设计
- **用户系统**: TenantUsers, UserSessions
- **租户管理**: 多租户配置和隔离
- **Agent系统**: Agent配置和模板
- **API密钥**: AgentApiKeys管理和验证
- **聊天系统**: 消息流和处理

## API设计模式

### 1. 统一响应格式
```python
{
    "success": true,
    "message": "操作成功",
    "data": {...},
    "timestamp": "2025-12-02T10:30:00Z",
    "request_id": "req_abc123def456",
    "tenant_id": "tenant_789",
    "execution_time": 0.123
}
```

### 2. 错误处理标准
```python
{
    "success": false,
    "message": "操作失败",
    "error": "详细错误信息",
    "error_code": "VALIDATION_ERROR",
    "timestamp": "2025-12-02T10:30:00Z",
    "request_id": "req_abc123def456"
}
```

### 3. 分页响应格式
```python
{
    "success": true,
    "data": {
        "items": [...],
        "pagination": {
            "page": 1,
            "page_size": 20,
            "total": 100,
            "total_pages": 5,
            "has_next": true,
            "has_prev": false
        }
    }
}
```

## 内部服务设计

### 1. 无认证架构
- **直接访问**: 所有API接口都无需身份验证
- **网络安全**: 通过防火墙、VPN等网络层面控制访问权限
- **内部专用**: 设计为内部服务，仅限可信网络访问

### 2. API密钥管理
- **格式**: `mmc_{tenant_id}_{agent_id}_{random_hash}_{version}`
- **功能**: 支持API密钥生成、解析、验证
- **使用场景**: 供外部服务调用聊天功能时的身份验证

### 3. 数据隔离
- **租户隔离**: 不同租户的数据完全隔离
- **Agent隔离**: 每个租户的Agent实例独立运行
- **聊天隔离**: 聊天消息按租户和Agent隔离存储

### 4. 操作权限
- **功能权限**: chat、config_read、config_write等细粒度控制
- **租户级权限**: 租户级别的资源访问控制
- **接口权限**: 基于接口功能的权限管理

## 租户管理模式

### 1. 租户生命周期
- **创建**: 直接创建租户（无需认证）
- **配置**: 租户信息和偏好设置
- **管理**: 租户状态和监控
- **删除**: 租户删除和数据清理

### 2. 资源隔离
- **数据隔离**: 每租户独立数据空间
- **配置隔离**: 租户特定的配置管理
- **实例隔离**: 独立的Agent实例

### 3. 计费和统计
- **使用统计**: API调用和资源使用统计
- **计费模式**: 基于使用量的计费
- **限制**: 请求频率和资源限制

## Agent管理系统

### 1. Agent模板
- **预定义模板**: 常用Agent角色模板
- **模板配置**: 标准化的Agent配置
- **自定义模板**: 用户自定义Agent模板

### 2. Agent配置
- **基础配置**: 名称、描述、类型
- **行为配置**: 个性、响应风格
- **能力配置**: 技能、权限、限制

### 3. 实例管理
- **实例创建**: 为租户创建Agent实例
- **配置更新**: 动态配置更新
- **生命周期**: Agent实例状态管理

## API密钥管理

### 1. 密钥生成
- **标准化格式**: 统一的密钥编码格式
- **安全随机**: 加密安全的随机数生成
- **版本控制**: 密钥版本管理

### 2. 权限管理
- **细粒度权限**: 具体功能权限控制
- **权限组**: 权限组合管理
- **动态权限**: 运行时权限验证

### 3. 监控和审计
- **使用统计**: 密钥使用情况监控
- **审计日志**: 完整的操作记录
- **安全控制**: 异常检测和封禁

## 聊天系统设计

### 1. 消息处理
- **多协议支持**: 支持多个聊天平台
- **消息路由**: 智能消息路由和分发
- **批量处理**: 批量消息处理优化

### 2. 实时通信
- **WebSocket**: 实时消息推送
- **流式响应**: 流式AI回复
- **连接管理**: 连接池和状态管理

### 3. 质量控制
- **内容过滤**: 消息内容安全检查
- **频率控制**: 消息发送频率限制
- **质量监控**: 服务质量和响应时间监控

## 监控和运维

### 1. 日志系统
- **结构化日志**: 标准化日志格式
- **日志级别**: 分级日志记录
- **日志轮转**: 自动日志清理

### 2. 性能监控
- **响应时间**: API响应时间监控
- **吞吐量**: 请求处理能力监控
- **资源使用**: 系统资源使用监控

### 3. 健康检查
- **服务健康**: 服务状态检查
- **依赖检查**: 外部依赖检查
- **自动恢复**: 故障自动恢复机制

## 部署和扩展

### 1. 容器化部署
- **Docker**: 应用容器化
- **编排**: Docker Compose编排
- **环境隔离**: 开发、测试、生产环境隔离

### 2. 负载均衡
- **水平扩展**: 多实例部署
- **负载分发**: 请求负载均衡
- **故障转移**: 自动故障转移

### 3. 数据库优化
- **连接池**: 数据库连接池管理
- **查询优化**: SQL查询性能优化
- **缓存策略**: Redis缓存策略

## 开发规范

### 1. 代码规范
- **Python**: 遵循PEP 8编码规范
- **类型注解**: 完整的类型提示
- **文档字符串**: 详细的函数和类文档

### 2. 测试规范
- **单元测试**: 核心功能单元测试
- **集成测试**: API集成测试
- **性能测试**: 性能和压力测试

### 3. 版本管理
- **Git**: 版本控制和协作
- **分支策略**: 功能分支开发
- **发布管理**: 版本发布和回滚

## 安全考虑

### 1. 数据安全
- **加密存储**: 敏感数据加密存储
- **传输安全**: HTTPS强制传输
- **数据备份**: 定期数据备份

### 2. 访问控制
- **身份认证**: 多因素身份认证
- **权限最小化**: 最小权限原则
- **访问审计**: 完整的访问记录

### 3. 网络安全
- **防火墙**: 网络访问控制
- **入侵检测**: 安全威胁检测
- **漏洞管理**: 安全漏洞修复