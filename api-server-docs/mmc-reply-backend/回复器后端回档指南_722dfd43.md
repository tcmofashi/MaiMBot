# MaiMBot 回复器后端回档指南

## 概述

本文档提供了将MaiMBot回复器后端源码回档到指定git commit `722dfd43ffd5ddfc93356d41f2b363ed00afd975` 之前的详细指南。

**目标git hash**: `722dfd43ffd5ddfc93356d41f2b363ed00afd975`
**提交信息**: "feat: 增加agent维度"
**回档原则**: 只回档回复器后端相关文件，保持配置器后端不变

## 分类说明

### 🎯 回复器后端（需要回档）

**定义**: 除了`src/api`目录之外，`src/`内的所有其他文件都属于回复器后端，负责机器人的核心聊天和回复功能。

**包含内容**:
- `src/chat/` - 聊天系统
- `src/agent/` - Agent管理
- `src/memory_system/` - 记忆系统
- `src/plugin_system/` - 插件系统
- `src/llm_models/` - LLM模型客户端
- `src/config/` - 配置核心（非API相关）
- `src/common/` - 通用工具（非API相关）
- `src/isolation/` - 隔离系统
- `src/core/` - 核心管理（非API相关）
- `src/express/` - 表达系统
- `src/mood/` - 情绪系统
- `src/person_info/` - 个人信息
- `src/jargon/` - 黑话系统
- `main.py` - 主程序入口

### ⚙️ 配置器后端（不需要回档）

**定义**: 只有`src/api/`目录下的文件属于配置器后端，负责API接口、多租户管理等功能。

**包含内容**:
- `src/api/` - 所有API相关文件

## 需要回档的文件清单

### 🎯 回复器后端（需要回档的所有文件）

**规则**: 除了`src/api/`目录之外，`src/`内的所有其他文件都需要回档

### 📋 需要回档的目录列表

| 目录路径 | 说明 | 状态 |
|----------|------|------|
| `src/chat/` | 聊天系统核心 | **全部回档** |
| `src/agent/` | Agent管理系统 | **全部回档** |
| `src/memory_system/` | 记忆系统 | **全部回档** |
| `src/plugin_system/` | 插件系统 | **全部回档** |
| `src/llm_models/` | LLM模型客户端 | **全部回档** |
| `src/config/` | 配置核心（非API相关） | **全部回档** |
| `src/common/` | 通用工具（非API相关） | **全部回档** |
| `src/isolation/` | 隔离系统 | **全部回档** |
| `src/core/` | 核心管理（非API相关） | **全部回档** |
| `src/express/` | 表达系统 | **全部回档** |
| `src/mood/` | 情绪系统 | **全部回档** |
| `src/person_info/` | 个人信息管理 | **全部回档** |
| `src/jargon/` | 黑话系统 | **全部回档** |
| `main.py` | 主程序入口 | **需要回档** |

## ⚙️ 不需要回档的文件清单

### 配置器后端（保持当前状态）

| 目录路径 | 说明 | 状态 |
|----------|------|------|
| `src/api/` | API接口和路由 | **不回档** |

### 测试和文档文件

| 目录路径 | 说明 | 状态 |
|----------|------|------|
| `MaiM_api_sever_test/` | API测试文件 | **不回档** |
| `integration_tests/` | 集成测试 | **不回档** |
| `docs/` | 项目文档 | **不回档** |
| `api-server-docs/` | API文档 | **不回档** |

### 配置和脚本文件

| 文件路径 | 说明 | 状态 |
|----------|------|------|
| `template/` | 配置模板 | **不回档** |
| `scripts/` | 工具脚本 | **不回档** |
| `plugins/` | 插件目录 | **不回档** |
| `requirements.txt` | 依赖文件 | **不回档** |
| `pyproject.toml` | 项目配置 | **不回档** |

## 回档操作步骤

### 步骤1：创建分支

```bash
# 创建新分支用于回档
git checkout -b revert-reply-backend-722dfd43
git checkout 722dfd43ffd5ddfc93356d41f2b363ed00afd975
```

### 步骤2：重置到目标commit

```bash
# 重置到目标commit，但保留工作区
git reset --soft HEAD~1

# 查看需要修改的文件
git status
```

### 步骤3：选择性地恢复文件

```bash
# 恢复配置器后端文件（保持当前状态）
git checkout HEAD -- src/api/

# 对于需要回档的文件，保持重置状态
# 除了src/api/之外的所有src/文件都已经标记为待修改状态
```

### 步骤4：删除新增的隔离文件

由于722dfd43之后新增了很多文件，需要删除不属于原始回复器后端的文件：

```bash
# 删除所有isolated_*文件
find src/ -name "isolated_*" -type f -delete

# 删除其他新增的后端系统文件
rm -rf src/memory_system/service/
rm -f src/curiousity/questions.py
rm -rf src/migrate_helper/
```

### 步骤5：处理依赖问题

回档后可能需要处理一些依赖问题：

1. **检查import错误**: 修复因回档导致的import错误
2. **配置兼容**: 确保配置文件与回档后的代码兼容
3. **插件兼容**: 确保插件系统与回档后的代码兼容

### 步骤6：测试验证

```bash
# 运行基础测试
python -m pytest tests/

# 检查基本功能
python bot.py --test
```

## 注意事项

### ⚠️ 重要提醒

1. **备份当前状态**: 在进行回档操作前，务必创建完整备份
2. **测试充分**: 回档后需要充分测试所有核心功能
3. **依赖检查**: 仔细检查所有依赖关系和import路径
4. **配置兼容**: 确保配置文件与回档后的代码兼容

### 🔧 技术考虑

1. **数据库模型**: 确保数据库模型与回档后的代码兼容
2. **API接口**: 配置器后端的API接口应该继续正常工作
3. **插件系统**: 插件可能需要适配回档后的核心代码
4. **消息格式**: 确保消息格式与回档后的代码兼容

### 📋 验证清单

回档完成后，需要验证以下功能：

- [ ] 基础聊天功能正常
- [ ] 消息接收和处理正常
- [ ] 回复生成功能正常
- [ ] 心流系统正常工作
- [ ] 表情系统正常工作
- [ ] 记忆系统正常工作
- [ ] 插件系统正常工作
- [ ] 配置器后端API正常工作
- [ ] 数据库连接正常
- [ ] 日志系统正常

## 应急方案

如果回档后出现问题：

1. **立即恢复**: 使用备份恢复到回档前的状态
2. **部分回滚**: 只回滚有问题的特定文件
3. **增量修复**: 逐步修复回档后出现的问题
4. **文档记录**: 详细记录问题和解决方案

## 联系信息

如果在回档过程中遇到技术问题，请：

1. 查看项目文档和提交历史
2. 联系开发团队获取支持
3. 记录详细的错误信息和操作步骤

---

**文档版本**: 1.0.0
**创建日期**: 2025-12-03
**目标commit**: 722dfd43ffd5ddfc93356d41f2b363ed00afd975
**适用版本**: MaiMBot v2.0+

**免责声明**: 本文档仅供参考，实际回档操作请根据具体情况进行调整。