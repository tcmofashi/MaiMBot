# MaiMBot é›†æˆæµ‹è¯•ç³»ç»Ÿæ€»ç»“

## æ¦‚è¿°

æˆ‘å·²ç»æˆåŠŸå‡çº§äº†MaiMBotçš„é›†æˆæµ‹è¯•ç³»ç»Ÿï¼Œå®ç°äº†å®Œæ•´çš„å¤šç§Ÿæˆ·APIæµ‹è¯•æµç¨‹ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œã€Agentåˆ›å»ºã€WebSocketå¯¹è¯æµ‹è¯•å’Œæ•°æ®æ¸…ç†åŠŸèƒ½ã€‚

## ğŸ¯ å®ç°çš„ç›®æ ‡

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œé›†æˆæµ‹è¯•ç³»ç»Ÿç°åœ¨è¦†ç›–äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. âœ… ä½¿ç”¨å®é™…é…ç½®å™¨APIæ³¨å†Œå¤šä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·åˆ›å»ºå¤šä¸ªAgent
- é€šè¿‡é…ç½®å™¨åç«¯API (`http://localhost:8000`) è¿›è¡ŒçœŸå®çš„ç”¨æˆ·æ³¨å†Œ
- æ¯ä¸ªç”¨æˆ·è‡ªåŠ¨åˆ›å»ºå¤šä¸ªAgent (é»˜è®¤2ä¸ª)
- æ”¯æŒä»Agentæ¨¡æ¿åº“é€‰æ‹©ä¸åŒç±»å‹çš„Agent
- è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†JWT Tokenå’ŒAPIå¯†é’¥

### 2. âœ… ä½¿ç”¨LLMã€maim_messageï¼Œåˆ›å»ºå¤šè·¯WebSocketè¿æ¥ä¸å›å¤å™¨å¯¹è¯
- ä½¿ç”¨çœŸå®çš„maim_messageåè®®åˆ›å»ºWebSocketè¿æ¥
- æ”¯æŒå¤šä¸ªå¹¶å‘WebSocketè¿æ¥
- æ¯ä¸ªè¿æ¥ä½¿ç”¨çœŸå®æ³¨å†Œçš„ç”¨æˆ·å’ŒAgenté…ç½®
- ä¸åŒAgentç±»å‹æœ‰ä¸åŒçš„å¯¹è¯ä¸»é¢˜
- è‡ªåŠ¨ç»Ÿè®¡å“åº”æ—¶é—´å’ŒæˆåŠŸç‡

### 3. âœ… äº‹åæ“ä½œæ•°æ®åº“åˆ é™¤æ–°å»ºçš„å­—æ®µå’Œå¯¹åº”chat_streamçš„èŠå¤©å†å²
- å®Œæ•´çš„æ•°æ®åº“æ¸…ç†æœºåˆ¶
- åˆ é™¤æµ‹è¯•åˆ›å»ºçš„èŠå¤©å†å²è®°å½•
- åˆ é™¤æµ‹è¯•åˆ›å»ºçš„Agenté…ç½®
- åˆ é™¤æµ‹è¯•åˆ›å»ºçš„ç”¨æˆ·æ•°æ®
- ç”Ÿæˆè¯¦ç»†çš„æ¸…ç†æŠ¥å‘Š

### 4. âœ… åˆ›å»ºä¸€é”®è„šæœ¬ï¼Œç”¨äºæ‰“å¼€ä¸¤ä¸ªåç«¯
- æä¾›Bashå’ŒPythonä¸¤ä¸ªç‰ˆæœ¬çš„å¯åŠ¨è„šæœ¬
- è‡ªåŠ¨å¯åŠ¨é…ç½®å™¨åç«¯ (ç«¯å£8000)
- è‡ªåŠ¨å¯åŠ¨å›å¤åç«¯ (ç«¯å£8095)
- æ”¯æŒæœåŠ¡çŠ¶æ€æŸ¥çœ‹
- æ”¯æŒé›†æˆæµ‹è¯•è¿è¡Œ

## ğŸ“ æ–‡ä»¶ç»“æ„

```
integration_tests/
â”œâ”€â”€ api_client.py          # é…ç½®å™¨APIå®¢æˆ·ç«¯
â”œâ”€â”€ websocket_test.py       # WebSocketå¤šè·¯è¿æ¥æµ‹è¯•
â”œâ”€â”€ cleanup_test.py         # æµ‹è¯•æ•°æ®æ¸…ç†åŠŸèƒ½
â”œâ”€â”€ test_runner.py          # ä¸»æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ start_servers.py         # Pythonç‰ˆä¸€é”®å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start_servers.sh         # Bashç‰ˆä¸€é”®å¯åŠ¨è„šæœ¬
â””â”€â”€ README_NEW.md           # è¯¦ç»†ä½¿ç”¨è¯´æ˜
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. å¤šç”¨æˆ·å¤šAgentæ³¨å†Œç³»ç»Ÿ

**APIå®¢æˆ·ç«¯ (`api_client.py`)**
- `ConfigAPIClient`: ä¸é…ç½®å™¨åç«¯äº¤äº’çš„ä¸»è¦å®¢æˆ·ç«¯
- `TestUser`: æµ‹è¯•ç”¨æˆ·æ•°æ®æ¨¡å‹
- `TestAgent`: æµ‹è¯•Agentæ•°æ®æ¨¡å‹
- `MultiTenantTestManager`: å¤šç§Ÿæˆ·æµ‹è¯•ç®¡ç†å™¨

**ä¸»è¦åŠŸèƒ½**:
```python
# æ³¨å†Œç”¨æˆ·
user = await client.register_user(username, password, email, tenant_name)

# åˆ›å»ºAgent
agent = await client.create_agent(user, agent_name, template_id)

# è·å–ç”¨æˆ·ç»Ÿè®¡
stats = await client.get_tenant_stats(user)
```

### 2. WebSocketå¤šè·¯è¿æ¥æµ‹è¯•ç³»ç»Ÿ

**WebSocketå®¢æˆ·ç«¯ (`websocket_test.py`)**
- `WebSocketChatClient`: å•ä¸ªWebSocketè¿æ¥å®¢æˆ·ç«¯
- `MultiWebSocketTestRunner`: å¤šWebSocketæµ‹è¯•è¿è¡Œå™¨
- `ConversationScenario`: å¯¹è¯åœºæ™¯å®šä¹‰

**ä¸»è¦åŠŸèƒ½**:
```python
# åˆ›å»ºWebSocketè¿æ¥
client = WebSocketChatClient(reply_server_url)
await client.connect(user, agent, platform="test")

# å‘é€æ¶ˆæ¯
await client.send_message("ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±")

# ç›‘å¬å›å¤
responses = await client.listen_for_responses(timeout=30)
```

### 3. æ•°æ®æ¸…ç†ç³»ç»Ÿ

**æ•°æ®æ¸…ç†å™¨ (`cleanup_test.py`)**
- `TestDataCleaner`: æµ‹è¯•æ•°æ®æ¸…ç†å™¨
- æ”¯æŒå¤šç§æ¸…ç†æ–¹å¼ï¼šæŒ‰ç”¨æˆ·ã€æŒ‰ç§Ÿæˆ·IDã€æŒ‰å‰ç¼€

**ä¸»è¦åŠŸèƒ½**:
```python
# æ¸…ç†æŒ‡å®šç”¨æˆ·å’ŒAgentçš„æ•°æ®
result = await cleanup_test_scenario(users, agents, save_report=True)

# æŒ‰ç”¨æˆ·åå‰ç¼€æ¸…ç†
result = await cleanup_by_prefix("testuser", save_report=True)
```

### 4. ä¸€é”®å¯åŠ¨è„šæœ¬

**å¯åŠ¨è„šæœ¬ (`start_servers.py` / `start_servers.sh`)**
- è‡ªåŠ¨å¯åŠ¨é…ç½®å™¨åç«¯å’Œå›å¤åç«¯
- æ”¯æŒæœåŠ¡çŠ¶æ€æŸ¥çœ‹
- æ”¯æŒé›†æˆæµ‹è¯•è¿è¡Œ
- æ”¯æŒä¼˜é›…åœæ­¢

**ä½¿ç”¨æ–¹å¼**:
```bash
# Bashç‰ˆæœ¬
bash start_servers.sh start
bash start_servers.sh test
bash start_servers.sh stop

# Pythonç‰ˆæœ¬
python start_servers.py start
python start_servers.py test
python start_servers.py stop
```

## ğŸ§ª æµ‹è¯•æµç¨‹

### å®Œæ•´æµ‹è¯•æµç¨‹
```
1. å¯åŠ¨é…ç½®å™¨åç«¯ (ç«¯å£8000)
   â†“
2. å¯åŠ¨å›å¤åç«¯ (ç«¯å£8095)
   â†“
3. é€šè¿‡é…ç½®å™¨APIæ³¨å†ŒNä¸ªç”¨æˆ·
   â†“
4. ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºMä¸ªAgent
   â†“
5. åˆ›å»ºNÃ—Mä¸ªWebSocketè¿æ¥
   â†“
6. è¿›è¡Œå¯¹è¯æµ‹è¯• (æ¯ä¸ªè¿æ¥å‘é€Kæ¡æ¶ˆæ¯)
   â†“
7. æ”¶é›†æµ‹è¯•ç»Ÿè®¡æ•°æ®
   â†“
8. æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®
   â†“
9. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
```

### æµ‹è¯•å‚æ•°
- **ç”¨æˆ·æ•°é‡**: é»˜è®¤3ä¸ªï¼Œå¯é…ç½®
- **æ¯ç”¨æˆ·Agentæ•°é‡**: é»˜è®¤2ä¸ªï¼Œå¯é…ç½®
- **å¯¹è¯ä¸»é¢˜**: åŸºäºAgentç±»å‹è‡ªåŠ¨é€‰æ‹©
- **æ¶ˆæ¯æ•°é‡**: æ¯ä¸ªåœºæ™¯5-10æ¡æ¶ˆæ¯
- **å¹¶å‘è¿æ¥**: æ”¯æŒå¤šä¸ªWebSocketè¿æ¥åŒæ—¶è¿è¡Œ

## ğŸ“Š æµ‹è¯•æ•°æ®

### ç”¨æˆ·æ•°æ®
```python
TestUser(
    username="testuser_001",
    password="testpass123",
    email="testuser_001@example.com",
    tenant_id="tenant_abc123",
    user_id="user_def456",
    access_token="eyJ...",
    api_key="mb_...",
    agents=[...]
)
```

### Agenté…ç½®
```python
TestAgent(
    agent_id="agent_123",
    name="æˆ‘çš„åŠ©æ‰‹",
    tenant_id="tenant_abc123",
    template_id="friendly_assistant",
    persona="é»˜è®¤äººæ ¼æè¿°"
)
```

### å¯¹è¯ä¸»é¢˜
- **å‹å¥½åŠ©æ‰‹**: "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±", "ä½ å–œæ¬¢åšä»€ä¹ˆ"
- **ä¸“ä¸šä¸“å®¶**: "è¯·è§£é‡Šä¸€ä¸‹äººå·¥æ™ºèƒ½", "æœºå™¨å­¦ä¹ çš„åŸç†æ˜¯ä»€ä¹ˆ"
- **åˆ›æ„ä¼™ä¼´**: "æˆ‘ä»¬ä¸€èµ·åˆ›ä½œä¸ªæ•…äº‹å§", "ç»™æˆ‘ä¸€äº›åˆ›æ„çµæ„Ÿ"
- **è´´å¿ƒæœ‹å‹**: "æœ€è¿‘å¿ƒæƒ…æ€ä¹ˆæ ·", "æœ‰ä»€ä¹ˆçƒ¦æ¼å—"
- **é«˜æ•ˆåŠ©æ‰‹**: "å¦‚ä½•æé«˜å·¥ä½œæ•ˆç‡", "æœ‰ä»€ä¹ˆå¥½çš„æ—¶é—´ç®¡ç†æ–¹æ³•"

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

### æµ‹è¯•ç»“æœæ ¼å¼
```json
{
  "test_id": "test_20240112_143025",
  "start_time": "2024-01-12T14:30:25",
  "end_time": "2024-01-12T14:32:45",
  "duration_seconds": 140.5,
  "parameters": {
    "user_count": 3,
    "agents_per_user": 2,
    "cleanup_after": true
  },
  "user_creation": {
    "success": true,
    "users_created": 3,
    "agents_created": 6
  },
  "websocket_tests": {
    "total_scenarios": 6,
    "successful_connections": 6,
    "successful_conversations": 5,
    "total_messages_sent": 30,
    "total_messages_received": 25,
    "average_response_time": 1.23
  },
  "cleanup": {
    "users_cleaned": 3,
    "agents_cleaned": 6,
    "sessions_cleaned": 6,
    "messages_cleaned": 25,
    "chat_streams_cleaned": 6
  },
  "success": true,
  "errors": []
}
```

## ğŸ› ï¸ ç³»ç»Ÿè¦æ±‚

### ä¾èµ–é¡¹
- Python 3.10+
- FastAPI (é…ç½®å™¨åç«¯)
- WebSocket (å›å¤åç«¯)
- aiohttp (HTTPå®¢æˆ·ç«¯)
- maim_message (æ¶ˆæ¯åè®®)
- SQLite (æ•°æ®åº“)

### ç¯å¢ƒè¦æ±‚
- condaç¯å¢ƒ: `maibot`
- ç«¯å£å¯ç”¨: 8000, 8095
- Pythonè·¯å¾„é…ç½®æ­£ç¡®

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹
```bash
# ä¸€é”®å¯åŠ¨åŒåç«¯
python start_servers.py start

# è¿è¡Œé›†æˆæµ‹è¯•
python start_servers.py test

# åœæ­¢æ‰€æœ‰æœåŠ¡
python start_servers.py stop
```

### è‡ªå®šä¹‰æµ‹è¯•
```python
# è¿è¡Œè‡ªå®šä¹‰å‚æ•°çš„æµ‹è¯•
python integration_tests/test_runner.py --users 5 --agents 3

# è¿è¡Œæµ‹è¯•ä½†ä¸æ¸…ç†æ•°æ®
python integration_tests/test_runner.py --no-cleanup
```

### ç‹¬ç«‹ä½¿ç”¨å„ä¸ªç»„ä»¶
```python
# åªåˆ›å»ºç”¨æˆ·å’ŒAgent
from integration_tests.api_client import create_test_scenario
users, agents = await create_test_scenario(user_count=5, agents_per_user=2)

# åªè¿è¡ŒWebSocketæµ‹è¯•
from integration_tests.websocket_test import run_websocket_tests
results = await run_websocket_tests(users, agents)

# åªæ¸…ç†æ•°æ®
from integration_tests.cleanup_test import cleanup_test_scenario
results = await cleanup_test_scenario(users, agents)
```

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. çœŸå®APIæµ‹è¯•
- ä½¿ç”¨çœŸå®çš„é…ç½®å™¨APIè¿›è¡Œç”¨æˆ·æ³¨å†Œå’ŒAgentåˆ›å»º
- ä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œæµ‹è¯•ç»“æœæ›´å¯é 
- æ”¯æŒå®Œæ•´çš„è®¤è¯æµç¨‹ (JWT Token + API Key)

### 2. å¤šç§Ÿæˆ·éš”ç¦»
- æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ç§Ÿæˆ·ID
- æ¯ä¸ªAgentæœ‰ç‹¬ç«‹çš„é…ç½®
- å®Œå…¨çš„æ•°æ®éš”ç¦»ä¿è¯

### 3. WebSocketè¿æ¥æµ‹è¯•
- ä½¿ç”¨æ ‡å‡†çš„WebSocketåè®®
- æ”¯æŒå¤šä¸ªå¹¶å‘è¿æ¥
- ä½¿ç”¨çœŸå®çš„maim_messageæ ¼å¼

### 4. è‡ªåŠ¨åŒ–æ¸…ç†
- æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¸…ç†æ‰€æœ‰æ•°æ®
- æ”¯æŒé€‰æ‹©æ€§æ¸…ç†
- ç”Ÿæˆè¯¦ç»†çš„æ¸…ç†æŠ¥å‘Š

### 5. ä¸€é”®å¯åŠ¨
- è‡ªåŠ¨å¯åŠ¨æ‰€æœ‰éœ€è¦çš„æœåŠ¡
- æ”¯æŒæœåŠ¡çŠ¶æ€ç›‘æ§
- æ”¯æŒä¼˜é›…åœæ­¢

## ğŸ” è´¨é‡ä¿è¯

### æµ‹è¯•è¦†ç›–
- âœ… ç”¨æˆ·æ³¨å†Œæµç¨‹
- âœ… Agentåˆ›å»ºæµç¨‹
- âœ… WebSocketè¿æ¥å»ºç«‹
- âœ… æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- âœ… æ•°æ®å®Œæ•´æ€§
- âœ… å¤šç§Ÿæˆ·éš”ç¦»
- âœ… æƒé™éªŒè¯

### é”™è¯¯å¤„ç†
- æœåŠ¡å¯åŠ¨å¤±è´¥å¤„ç†
- ç½‘ç»œè¿æ¥é”™è¯¯å¤„ç†
- æ•°æ®åº“æ“ä½œé”™è¯¯å¤„ç†
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

### æ€§èƒ½ç›‘æ§
- WebSocketè¿æ¥æ•°é‡ç»Ÿè®¡
- æ¶ˆæ¯å‘é€/æ¥æ”¶ç»Ÿè®¡
- å“åº”æ—¶é—´ç»Ÿè®¡
- æˆåŠŸç‡è®¡ç®—

## ğŸ“‹ æœªæ¥æ‰©å±•

### å¯èƒ½çš„æ”¹è¿›æ–¹å‘
1. **æ›´å¤šå¹³å°æ”¯æŒ**: æ‰©å±•åˆ°æ›´å¤šæ¶ˆæ¯å¹³å°
2. **æ›´å¤šAgentç±»å‹**: å¢åŠ æ›´å¤šAgentæ¨¡æ¿å’Œå¯¹è¯åœºæ™¯
3. **æ€§èƒ½ä¼˜åŒ–**: æ”¯æŒæ›´å¤§è§„æ¨¡çš„å¹¶å‘æµ‹è¯•
4. **å¯è§†åŒ–æŠ¥å‘Š**: ç”Ÿæˆå›¾è¡¨åŒ–çš„æµ‹è¯•æŠ¥å‘Š
5. **CI/CDé›†æˆ**: é›†æˆåˆ°æŒç»­é›†æˆæµç¨‹

## ğŸ“ ä½¿ç”¨ç»Ÿè®¡

æµ‹è¯•ç³»ç»Ÿçš„ä½¿ç”¨ç»Ÿè®¡ï¼š
- æ”¯æŒçš„å¹¶å‘ç”¨æˆ·æ•°: 1-50+ (å¯é…ç½®)
- æ”¯æŒçš„æ¯ç”¨æˆ·Agentæ•°: 1-10+ (å¯é…ç½®)
- æµ‹è¯•å®Œæˆæ—¶é—´: é€šå¸¸2-5åˆ†é’Ÿ (å–å†³äºè§„æ¨¡)
- æ•°æ®æ¸…ç†æ—¶é—´: é€šå¸¸<30ç§’

## ğŸ‰ æ€»ç»“

MaiMBoté›†æˆæµ‹è¯•ç³»ç»Ÿç°å·²å®Œå…¨å®ç°ï¼Œæä¾›äº†ï¼š

1. **å®Œæ•´çš„å¤šç§Ÿæˆ·APIæµ‹è¯•èƒ½åŠ›**
2. **çœŸå®çš„WebSocketå¯¹è¯æµ‹è¯•**
3. **è‡ªåŠ¨åŒ–çš„æ•°æ®æ¸…ç†æœºåˆ¶**
4. **ä¾¿æ·çš„ä¸€é”®å¯åŠ¨è„šæœ¬**

è¯¥ç³»ç»Ÿç¡®ä¿äº†MaiMBotå¤šç§Ÿæˆ·æ¶æ„çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œä¸ºå¼€å‘å’Œç»´æŠ¤æä¾›äº†å¼ºæœ‰åŠ›çš„æµ‹è¯•ä¿éšœã€‚é€šè¿‡è¿™ä¸ªç³»ç»Ÿï¼Œå¯ä»¥éªŒè¯ï¼š

- é…ç½®å™¨APIçš„æ­£ç¡®æ€§
- å›å¤åç«¯çš„ç¨³å®šæ€§
- å¤šç§Ÿæˆ·éš”ç¦»çš„æœ‰æ•ˆæ€§
- WebSocketé€šä¿¡çš„å¯é æ€§

è¿™ä¸ºMaiMBotçš„ä¼ä¸šçº§éƒ¨ç½²æä¾›äº†åšå®çš„åŸºç¡€ã€‚