# MaiBot å¤šç§Ÿæˆ·éš”ç¦»æ¶æ„éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

- [éƒ¨ç½²æ¦‚è¿°](#éƒ¨ç½²æ¦‚è¿°)
- [å‰ç½®è¦æ±‚](#å‰ç½®è¦æ±‚)
- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [æ•°æ®åº“è¿ç§»](#æ•°æ®åº“è¿ç§»)
- [åº”ç”¨é…ç½®](#åº”ç”¨é…ç½®)
- [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
- [éªŒè¯éƒ¨ç½²](#éªŒè¯éƒ¨ç½²)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)

## ğŸ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»çš„MaiBotç³»ç»Ÿã€‚å¤šç§Ÿæˆ·æ¶æ„æä¾›äº†ä¼ä¸šçº§çš„æ•°æ®éš”ç¦»ã€æ‰©å±•èƒ½åŠ›å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

### æ”¯æŒçš„éƒ¨ç½²æ¨¡å¼

1. **å•æœºå¤šç§Ÿæˆ·éƒ¨ç½²** - é€‚ç”¨äºå°å‹å›¢é˜Ÿæˆ–åˆåˆ›ä¼ä¸š
2. **åˆ†å¸ƒå¼å¤šç§Ÿæˆ·éƒ¨ç½²** - é€‚ç”¨äºä¸­å¤§å‹ä¼ä¸š
3. **å®¹å™¨åŒ–éƒ¨ç½²** - é€‚ç”¨äºäº‘åŸç”Ÿç¯å¢ƒ
4. **Kuberneteséƒ¨ç½²** - é€‚ç”¨äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å››ç»´éš”ç¦»** (T+A+C+P) - ç§Ÿæˆ·+æ™ºèƒ½ä½“+èŠå¤©æµ+å¹³å°
- âœ… **æ°´å¹³æ‰©å±•** - æ”¯æŒæ— é™ç§Ÿæˆ·å’Œæ™ºèƒ½ä½“
- âœ… **é«˜æ€§èƒ½** - ä¼˜åŒ–çš„æ•°æ®åº“æŸ¥è¯¢å’Œç¼“å­˜
- âœ… **å‘åå…¼å®¹** - æ— ç¼å‡çº§ç°æœ‰ç³»ç»Ÿ
- âœ… **ç›‘æ§å°±ç»ª** - å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—ä½“ç³»

## ğŸ”§ å‰ç½®è¦æ±‚

### ç³»ç»Ÿè¦æ±‚

#### æœ€ä½é…ç½®
- **CPU**: 2æ ¸å¿ƒ
- **å†…å­˜**: 4GB RAM
- **å­˜å‚¨**: 20GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥
- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 20.04+) / macOS / Windows 10+

#### æ¨èé…ç½®
- **CPU**: 4æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 8GB+ RAM
- **å­˜å‚¨**: 100GB+ SSD
- **ç½‘ç»œ**: é«˜é€Ÿäº’è”ç½‘è¿æ¥
- **è´Ÿè½½å‡è¡¡å™¨**: Nginx/HAProxy (ç”Ÿäº§ç¯å¢ƒ)

#### ä¼ä¸šçº§é…ç½®
- **CPU**: 8æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 16GB+ RAM
- **å­˜å‚¨**: 500GB+ é«˜é€ŸSSD
- **æ•°æ®åº“**: PostgreSQL/MySQL (æ¨è)
- **ç¼“å­˜**: Redis é›†ç¾¤
- **æ¶ˆæ¯é˜Ÿåˆ—**: RabbitMQ/Apache Kafka

### è½¯ä»¶ä¾èµ–

```bash
# Python ç¯å¢ƒ
Python 3.10+ (æ¨è 3.11)

# æ•°æ®åº“ (ä»»é€‰å…¶ä¸€)
SQLite 3.36+ (å¼€å‘/å°å‹éƒ¨ç½²)
PostgreSQL 13+ (æ¨è)
MySQL 8.0+
MariaDB 10.6+

# å¯é€‰ç»„ä»¶
Redis 6.0+ (ç¼“å­˜å’Œä¼šè¯)
Docker 20.10+ (å®¹å™¨åŒ–éƒ¨ç½²)
Kubernetes 1.24+ (K8séƒ¨ç½²)
```

## ğŸš€ ç¯å¢ƒå‡†å¤‡

### 1. åˆ›å»ºé¡¹ç›®ç¯å¢ƒ

```bash
# å…‹éš†é¡¹ç›® (å¦‚æœè¿˜æ²¡æœ‰)
git clone https://github.com/MaiM-with-u/MaiBot.git
cd MaiBot

# åˆ›å»º conda ç¯å¢ƒ
conda create -n maibot python=3.11
conda activate maibot

# æˆ–ä½¿ç”¨ virtual environment
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ– venv\Scripts\activate  # Windows
```

### 2. å®‰è£…ä¾èµ–

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt

# ç”Ÿäº§ç¯å¢ƒé¢å¤–ä¾èµ–
pip install -r requirements-prod.txt  # å¦‚æœå­˜åœ¨

# å®‰è£…å¤šç§Ÿæˆ·ç›¸å…³ä¾èµ–
pip install sqlalchemy alembic redis psycopg2-binary
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# åŸºç¡€é…ç½®
MAIMBOT_ENV=production
DEBUG=false
LOG_LEVEL=INFO

# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///MaiBot.db
# æˆ– PostgreSQL
# DATABASE_URL=postgresql://user:password@localhost:5432/maibot

# Redis é…ç½® (å¯é€‰)
REDIS_URL=redis://localhost:6379/0

# å¤šç§Ÿæˆ·é…ç½®
MULTI_TENANT_ENABLED=true
DEFAULT_TENANT_ID=default

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key-here
JWT_SECRET_KEY=your-jwt-secret-key

# LLM é…ç½®
OPENAI_API_KEY=your-openai-api-key
# æˆ–å…¶ä»– LLM é…ç½®
```

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»

### 1. æ•°æ®åº“å¤‡ä»½ (é‡è¦!)

```bash
# SQLite å¤‡ä»½
cp MaiBot.db MaiBot.db.backup.$(date +%Y%m%d_%H%M%S)

# PostgreSQL å¤‡ä»½
pg_dump maibot > maibot_backup_$(date +%Y%m%d_%H%M%S).sql

# MySQL å¤‡ä»½
mysqldump maibot > maibot_backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. æ‰§è¡Œå¤šç§Ÿæˆ·è¿ç§»

```bash
# æ£€æŸ¥è¿ç§»çŠ¶æ€
python scripts/run_multi_tenant_migration.py --check

# æ‰§è¡Œè¿ç§»
python scripts/run_multi_tenant_migration.py --migrate

# éªŒè¯è¿ç§»ç»“æœ
python scripts/run_multi_tenant_migration.py --check
```

### 3. é…ç½®æ•°æ®åº“ (ç”Ÿäº§ç¯å¢ƒ)

#### PostgreSQL é…ç½®ç¤ºä¾‹

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE maibot;
CREATE USER maibot_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE maibot TO maibot_user;

-- ä¼˜åŒ–é…ç½®
-- åœ¨ postgresql.conf ä¸­è®¾ç½®:
-- shared_buffers = 256MB
-- effective_cache_size = 1GB
-- maintenance_work_mem = 64MB
-- checkpoint_completion_target = 0.9
-- wal_buffers = 16MB
-- default_statistics_target = 100
```

#### MySQL é…ç½®ç¤ºä¾‹

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE maibot CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'maibot_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON maibot.* TO 'maibot_user'@'localhost';
FLUSH PRIVILEGES;
```

## âš™ï¸ åº”ç”¨é…ç½®

### 1. å¤šç§Ÿæˆ·é…ç½®æ–‡ä»¶

åˆ›å»º `config/multi_tenant_config.toml`:

```toml
[multi_tenant]
enabled = true
default_tenant_id = "default"
max_tenants = 1000
isolation_level = "strict"

# é»˜è®¤ç§Ÿæˆ·é…ç½®
[tenants.default]
name = "é»˜è®¤ç§Ÿæˆ·"
description = "ç³»ç»Ÿé»˜è®¤ç§Ÿæˆ·"
enabled = true
max_agents = 10
max_chat_streams = 100
platforms = ["qq", "discord"]

# ç¤ºä¾‹ç§Ÿæˆ·é…ç½®
[tenants.enterprise]
name = "ä¼ä¸šç§Ÿæˆ·"
description = "ä¼ä¸šçº§ç§Ÿæˆ·é…ç½®"
enabled = true
max_agents = 100
max_chat_streams = 1000
platforms = ["qq", "discord", "slack", "telegram"]

# LLM é…é¢
[tenants.enterprise.quotas]
daily_llm_requests = 10000
monthly_llm_tokens = 1000000
storage_quota_mb = 10240
```

### 2. æ—¥å¿—é…ç½®

åˆ›å»º `config/logging.toml`:

```toml
[logging]
level = "INFO"
format = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

[handlers.file]
class = "logging.handlers.RotatingFileHandler"
filename = "logs/maibot.log"
max_bytes = 10485760  # 10MB
backup_count = 5
level = "INFO"

[handlers.console]
class = "logging.StreamHandler"
level = "INFO"
stream = "ext://sys.stdout"

[loggers.maibot]
level = "INFO"
handlers = ["file", "console"]
propagate = false

[loggers.sqlalchemy]
level = "WARNING"
handlers = ["file"]
propagate = false
```

### 3. æ€§èƒ½ä¼˜åŒ–é…ç½®

åˆ›å»º `config/performance.toml`:

```toml
[performance]
database_pool_size = 20
database_max_overflow = 30
redis_pool_size = 50
cache_ttl_seconds = 3600
batch_size = 1000
max_concurrent_requests = 1000

[monitoring]
enabled = true
metrics_port = 9090
health_check_interval = 30
performance_tracking = true
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€: ä¼ ç»Ÿéƒ¨ç½²

```bash
# 1. å‡†å¤‡ç¯å¢ƒ
conda activate maibot

# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
python scripts/run_multi_tenant_migration.py --migrate

# 3. åˆå§‹åŒ–é…ç½®
python scripts/init_config.py

# 4. å¯åŠ¨åº”ç”¨
python bot.py

# 5. éªŒè¯éƒ¨ç½²
curl http://localhost:8080/health
```

### æ–¹å¼äºŒ: Docker éƒ¨ç½²

åˆ›å»º `Dockerfile.prod`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN useradd -m -u 1000 maibot
RUN chown -R maibot:maibot /app
USER maibot

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
CMD ["python", "bot.py"]
```

åˆ›å»º `docker-compose.prod.yml`:

```yaml
version: '3.8'

services:
  maibot:
    build:
      context: .
      dockerfile: Dockerfile.prod
    ports:
      - "8080:8080"
    environment:
      - MAIMBOT_ENV=production
      - DATABASE_URL=postgresql://maibot:password@postgres:5432/maibot
      - REDIS_URL=redis://redis:6379/0
      - MULTI_TENANT_ENABLED=true
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    restart: unless-stopped

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=maibot
      - POSTGRES_USER=maibot
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - maibot
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

éƒ¨ç½²å‘½ä»¤:

```bash
# æ„å»ºå’Œå¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
docker-compose -f docker-compose.prod.yml exec maibot \
  python scripts/run_multi_tenant_migration.py --migrate

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f maibot
```

### æ–¹å¼ä¸‰: Kubernetes éƒ¨ç½²

åˆ›å»º `k8s/namespace.yaml`:

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: maibot
```

åˆ›å»º `k8s/configmap.yaml`:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: maibot-config
  namespace: maibot
data:
  MULTI_TENANT_ENABLED: "true"
  DEFAULT_TENANT_ID: "default"
  LOG_LEVEL: "INFO"
```

åˆ›å»º `k8s/deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: maibot
  namespace: maibot
spec:
  replicas: 3
  selector:
    matchLabels:
      app: maibot
  template:
    metadata:
      labels:
        app: maibot
    spec:
      containers:
      - name: maibot
        image: maibot:latest
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: maibot-config
        - secretRef:
            name: maibot-secrets
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

éƒ¨ç½²å‘½ä»¤:

```bash
# åº”ç”¨é…ç½®
kubectl apply -f k8s/

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
kubectl exec -n maibot deployment/maibot -- \
  python scripts/run_multi_tenant_migration.py --migrate

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n maibot
```

## âœ… éªŒè¯éƒ¨ç½²

### 1. å¥åº·æ£€æŸ¥

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# è¯¦ç»†å¥åº·æ£€æŸ¥
curl http://localhost:8080/health/detailed

# å¤šç§Ÿæˆ·çŠ¶æ€æ£€æŸ¥
curl http://localhost:8080/api/multi_tenant/status
```

é¢„æœŸå“åº”:

```json
{
  "status": "healthy",
  "timestamp": "2025-01-11T12:00:00Z",
  "version": "1.0.0",
  "multi_tenant": {
    "enabled": true,
    "tenants_count": 5,
    "agents_count": 12,
    "database_status": "connected"
  }
}
```

### 2. åŠŸèƒ½éªŒè¯

```python
# åˆ›å»ºæµ‹è¯•è„šæœ¬ test_deployment.py
import asyncio
from src.isolation.isolation_context import create_isolation_context
from src.chat.heart_flow.isolated_heartflow_api import create_isolated_heartflow_processor

async def test_multi_tenant():
    # æµ‹è¯•ç§Ÿæˆ·éš”ç¦»
    context1 = create_isolation_context("tenant1", "agent1", "qq")
    context2 = create_isolation_context("tenant2", "agent1", "qq")

    processor1 = create_isolated_heartflow_processor("tenant1", "agent1")
    processor2 = create_isolated_heartflow_processor("tenant2", "agent1")

    print("âœ… å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•é€šè¿‡")

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    from src.common.database.isolation_query_examples import get_isolated_query_manager
    query_manager = get_isolated_query_manager(context1)
    overview = query_manager.get_tenant_overview()
    print(f"âœ… æ•°æ®åº“æµ‹è¯•é€šè¿‡: {overview}")

if __name__ == "__main__":
    asyncio.run(test_multi_tenant())
```

è¿è¡Œæµ‹è¯•:

```bash
python test_deployment.py
```

### 3. æ€§èƒ½éªŒè¯

```bash
# å®‰å‹æµ‹è¯•å·¥å…·
pip install locust

# åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬ performance_test.py
from locust import HttpUser, task, between

class MaiBotUser(HttpUser):
    wait_time = between(1, 3)

    @task
    def health_check(self):
        self.client.get("/health")

    @task
    def tenant_status(self):
        self.client.get("/api/multi_tenant/status")

    @task
    def create_agent(self):
        self.client.post("/api/agents", json={
            "tenant_id": "test_tenant",
            "agent_id": "test_agent",
            "name": "æµ‹è¯•æ™ºèƒ½ä½“"
        })

# è¿è¡Œæ€§èƒ½æµ‹è¯•
locust -f performance_test.py --host=http://localhost:8080
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX CONCURRENTLY idx_messages_isolation
ON messages(tenant_id, agent_id, platform, chat_stream_id);

CREATE INDEX CONCURRENTLY idx_memory_chest_isolation
ON memory_chest(tenant_id, agent_id, platform, chat_stream_id);

-- åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE messages;
ANALYZE memory_chest;
ANALYZE chat_streams;
```

### 2. Redis ç¼“å­˜é…ç½®

```redis
# redis.conf ä¼˜åŒ–é…ç½®
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

### 3. åº”ç”¨å±‚ä¼˜åŒ–

```python
# config/performance.py
DATABASE_CONFIG = {
    "pool_size": 20,
    "max_overflow": 30,
    "pool_timeout": 30,
    "pool_recycle": 3600
}

REDIS_CONFIG = {
    "max_connections": 50,
    "retry_on_timeout": True,
    "socket_timeout": 5
}
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æ—¥å¿—ç›‘æ§

```bash
# é…ç½®æ—¥å¿—è½®è½¬
sudo vim /etc/logrotate.d/maibot

/path/to/maibot/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 maibot maibot
    postrotate
        systemctl reload maibot
    endscript
}
```

### 2. ç³»ç»Ÿç›‘æ§

ä½¿ç”¨ Prometheus + Grafana:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'maibot'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    scrape_interval: 5s
```

### 3. å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# health_check.sh

HEALTH_URL="http://localhost:8080/health"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)

if [ $RESPONSE -eq 200 ]; then
    echo "$(date): MaiBot is healthy"
    exit 0
else
    echo "$(date): MaiBot is unhealthy (HTTP $RESPONSE)"
    # å‘é€å‘Šè­¦
    curl -X POST "https://api.telegram.org/bot<token>/sendMessage" \
         -d "chat_id=<chat_id>" \
         -d "text=MaiBot health check failed!"
    exit 1
fi
```

### 4. è‡ªåŠ¨åŒ–ç»´æŠ¤

```bash
# æ·»åŠ åˆ° crontab
# æ¯æ—¥å¥åº·æ£€æŸ¥
0 */6 * * * /path/to/health_check.sh

# æ¯å‘¨æ—¥å¿—æ¸…ç†
0 2 * * 0 find /path/to/maibot/logs -name "*.log" -mtime +7 -delete

# æ¯æœˆæ•°æ®åº“ç»´æŠ¤
0 3 1 * * /path/to/database_maintenance.sh
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æ•°æ®åº“è¿æ¥é—®é¢˜

**ç—‡çŠ¶**: åº”ç”¨å¯åŠ¨å¤±è´¥ï¼Œæç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
systemctl status postgresql

# æ£€æŸ¥è¿æ¥é…ç½®
python -c "
from src.common.database.database_model import engine
try:
    engine.connect()
    print('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸')
except Exception as e:
    print(f'âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}')
"

# é‡ç½®æ•°æ®åº“è¿æ¥
docker-compose restart postgres
```

#### 2. å†…å­˜ä¸è¶³

**ç—‡çŠ¶**: åº”ç”¨å“åº”ç¼“æ…¢ï¼ŒOOMé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h
ps aux --sort=-%mem | head

# ä¼˜åŒ–å†…å­˜é…ç½®
export PYTHONOPTIMIZE=1
export MALLOC_TRIM_THRESHOLD_=100000

# é‡å¯åº”ç”¨é‡Šæ”¾å†…å­˜
systemctl restart maibot
```

#### 3. ç§Ÿæˆ·æ•°æ®æ³„éœ²

**ç—‡çŠ¶**: ä¸åŒç§Ÿæˆ·æ•°æ®æ··åˆ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥éš”ç¦»é…ç½®
curl http://localhost:8080/api/multi_tenant/isolation_check

# éªŒè¯æ•°æ®éš”ç¦»
python scripts/verify_tenant_isolation.py

# ä¿®å¤æ•°æ®éš”ç¦»é—®é¢˜
python scripts/fix_tenant_isolation.py
```

#### 4. æ€§èƒ½é—®é¢˜

**ç—‡çŠ¶**: APIå“åº”ç¼“æ…¢ï¼Œæ•°æ®åº“æŸ¥è¯¢è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ…¢æŸ¥è¯¢
python scripts/analyze_slow_queries.py

# ä¼˜åŒ–æ•°æ®åº“
VACUUM ANALYZE;
REINDEX DATABASE maibot;

# æ¸…ç†ç¼“å­˜
redis-cli FLUSHDB
systemctl restart maibot
```

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/maibot.log | grep ERROR

# åˆ†æè®¿é—®æ¨¡å¼
grep "tenant_id=" logs/maibot.log | awk '{print $NF}' | sort | uniq -c

# ç›‘æ§èµ„æºä½¿ç”¨
htop
iotop
```

## ğŸ›ï¸ é«˜çº§é…ç½®

### 1. å¤šæ•°æ®åº“æ”¯æŒ

```python
# config/database.py
DATABASE_ROUTES = {
    "default": "postgresql://...",
    "tenant_001": "postgresql://...",
    "tenant_002": "mysql://...",
    "analytics": "clickhouse://..."
}
```

### 2. å¾®æœåŠ¡æ¶æ„

```yaml
# docker-compose.microservices.yml
version: '3.8'

services:
  api-gateway:
    image: nginx:alpine
    ports:
      - "80:80"
    depends_on:
      - auth-service
      - chat-service
      - memory-service

  auth-service:
    build: ./services/auth
    environment:
      - DATABASE_URL=postgresql://...
    ports:
      - "8001:8000"

  chat-service:
    build: ./services/chat
    environment:
      - DATABASE_URL=postgresql://...
    ports:
      - "8002:8000"

  memory-service:
    build: ./services/memory
    environment:
      - DATABASE_URL=postgresql://...
    ports:
      - "8003:8000"
```

### 3. é›†ç¾¤éƒ¨ç½²

```bash
# ä½¿ç”¨ Docker Swarm
docker swarm init
docker stack deploy -c docker-compose.cluster.yml maibot

# ä½¿ç”¨ Kubernetes
kubectl scale deployment maibot --replicas=10
kubectl autoscale deployment maibot --cpu-percent=70 --min=3 --max=20
```

### 4. å®‰å…¨é…ç½®

```python
# config/security.py
SECURITY_CONFIG = {
    "jwt_secret_key": os.environ.get("JWT_SECRET_KEY"),
    "token_expire_hours": 24,
    "rate_limit": {
        "requests_per_minute": 100,
        "burst_size": 200
    },
    "encryption": {
        "algorithm": "AES-256-GCM",
        "key_rotation_days": 90
    }
}
```

## ğŸ“ æ”¯æŒå’Œå¸®åŠ©

### è·å–å¸®åŠ©

1. **æ–‡æ¡£èµ„æº**:
   - [é¡¹ç›®æ–‡æ¡£](https://docs.mai-mai.org)
   - [APIå‚è€ƒ](./API_REFERENCE.md)
   - [æµ‹è¯•æŠ¥å‘Š](./TEST_REPORT.md)

2. **ç¤¾åŒºæ”¯æŒ**:
   - GitHub Issues: [MaiBot Issues](https://github.com/MaiM-with-u/MaiBot/issues)
   - è®¨è®ºåŒº: [GitHub Discussions](https://github.com/MaiM-with-u/MaiBot/discussions)

3. **æ•…éšœæŠ¥å‘Š**:
   ```bash
   # æ”¶é›†è¯Šæ–­ä¿¡æ¯
   python scripts/collect_diagnostic_info.py

   # ç”Ÿæˆæ”¯æŒåŒ…
   tar -czf maibot-support-$(date +%Y%m%d).tar.gz \
       logs/ \
       config/ \
       diagnostic_info.txt
   ```

### æœ€ä½³å®è·µ

1. **å®šæœŸå¤‡ä»½**: æ¯æ—¥è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“å’Œé…ç½®
2. **ç›‘æ§å‘Šè­¦**: è®¾ç½®å…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
3. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨Gitç®¡ç†é…ç½®æ–‡ä»¶
4. **å®‰å…¨æ›´æ–°**: å®šæœŸæ›´æ–°ä¾èµ–åŒ…å’Œç³»ç»Ÿè¡¥ä¸
5. **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´é…ç½®å‚æ•°

---

## ğŸ‰ éƒ¨ç½²å®Œæˆ

æ­å–œï¼æ‚¨å·²æˆåŠŸéƒ¨ç½²MaiBotå¤šç§Ÿæˆ·éš”ç¦»æ¶æ„ã€‚ç°åœ¨æ‚¨çš„ç³»ç»Ÿå…·å¤‡äº†ï¼š

- ğŸ”’ **ä¼ä¸šçº§æ•°æ®éš”ç¦»** - T+A+C+På››ç»´å®Œå…¨éš”ç¦»
- ğŸ“ˆ **é«˜å¯æ‰©å±•æ€§** - æ”¯æŒæ— é™ç§Ÿæˆ·å’Œæ™ºèƒ½ä½“
- âš¡ **é«˜æ€§èƒ½** - ä¼˜åŒ–çš„æ•°æ®åº“æŸ¥è¯¢å’Œç¼“å­˜
- ğŸ›¡ï¸ **é«˜å¯ç”¨æ€§** - å®Œæ•´çš„ç›‘æ§å’Œæ•…éšœæ¢å¤æœºåˆ¶
- ğŸ”§ **æ˜“ç»´æŠ¤æ€§** - è‡ªåŠ¨åŒ–è¿ç»´å’Œç®¡ç†å·¥å…·

æ¥ä¸‹æ¥å»ºè®®ï¼š
1. é…ç½®ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
2. è®¾ç½®å®šæœŸå¤‡ä»½ç­–ç•¥
3. è¿›è¡Œä¸šåŠ¡åœºæ™¯æµ‹è¯•
4. åŸ¹è®­è¿ç»´å›¢é˜Ÿ

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸš€