# Agent API è·¯ç”±å†²çªä¿®å¤æŠ¥å‘Š

**åˆ›å»ºæ—¶é—´**: 2025å¹´11æœˆ29æ—¥ 01:36:17  
**æœ€åä¿®æ”¹**: 2025å¹´11æœˆ29æ—¥ 01:36:17  
**AIç”Ÿæˆæ ‡è¯†**: Cline  
**æ–‡æ¡£ç±»å‹**: é—®é¢˜åˆ†æä¸ä¿®å¤æŠ¥å‘Š

## æ¦‚è¿°
æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†MaiMBot APIæœåŠ¡å™¨ä¸­Agentåˆ›å»ºåŠŸèƒ½å¤±æ•ˆé—®é¢˜çš„è¯Šæ–­ã€åˆ†æå’Œä¿®å¤è¿‡ç¨‹ã€‚é€šè¿‡æ·±å…¥åˆ†æè·¯ç”±å†²çªå’Œä»£ç é—®é¢˜ï¼ŒæˆåŠŸæ¢å¤äº†Agentç®¡ç†åŠŸèƒ½ã€‚

## é—®é¢˜æè¿°

### åˆå§‹ç—‡çŠ¶
- Agentåˆ›å»ºAPI (`POST /api/v1/agents`) è¿”å›405 Method Not Allowedé”™è¯¯
- Agentåˆ—è¡¨è·å–API (`GET /api/v1/agents`) è¿”å›500 Internal Server Error
- å®Œæ•´çš„APIé›†æˆæµ‹è¯•æ˜¾ç¤ºæ­¥éª¤8å’Œæ­¥éª¤9å¤±è´¥

### æµ‹è¯•ç»“æœå¯¹æ¯”

**ä¿®å¤å‰æµ‹è¯•ç»“æœï¼š**
```
ğŸ“‹ æ­¥éª¤ 8: è·å– Agent åˆ—è¡¨
âœ“ GET /api/v1/agents - çŠ¶æ€ç : 500

ğŸ†• æ­¥éª¤ 9: åˆ›å»º Agent
âœ“ POST /api/v1/agents - çŠ¶æ€ç : 405
```

**ä¿®å¤åæµ‹è¯•ç»“æœï¼š**
```
ğŸ“‹ æ­¥éª¤ 8: è·å– Agent åˆ—è¡¨
âœ“ GET /api/v1/agents - çŠ¶æ€ç : 200

ğŸ†• æ­¥éª¤ 9: åˆ›å»º Agent
âœ“ POST /api/v1/agents - çŠ¶æ€ç : 200
   åˆ›å»ºçš„ Agent ID: agent_b4c9eca378a358a6
```

## é—®é¢˜æ ¹æºåˆ†æ

### 1. è·¯ç”±å†²çªé—®é¢˜

**é—®é¢˜æè¿°ï¼š**
åœ¨FastAPIä¸­ï¼Œå¤šä¸ªè·¯ç”±å™¨æ³¨å†Œäº†ç›¸åŒçš„è·¯å¾„ `/api/v1/agents`ï¼Œå¯¼è‡´è·¯ç”±å†²çªã€‚

**å†²çªæ–‡ä»¶ï¼š**
- `src/api/routes/agent_api.py` - Agentç®¡ç†APIï¼Œå‰ç¼€ `/v1/agents`
- `src/api/routes/chat_api.py` - èŠå¤©APIï¼Œå‰ç¼€ `/v1` + è·¯å¾„ `/agents`

**å†²çªè·¯å¾„ï¼š**
- `agent_api.py`: `/api/v1/agents` (å®Œæ•´è·¯å¾„)
- `chat_api.py`: `/api/v1/agents` (å®Œæ•´è·¯å¾„)

**è·¯ç”±æ³¨å†Œé¡ºåºï¼š**
```python
# src/api/main.py ä¸­çš„æ³¨å†Œé¡ºåº
api_router.include_router(agent_router, tags=["Agentç®¡ç†"])  # å…ˆæ³¨å†Œ
api_router.include_router(chat_router, tags=["èŠå¤©v1"])     # åæ³¨å†Œï¼Œè¦†ç›–å‰ä¸€ä¸ª
```

ç”±äº `chat_router` åœ¨ `agent_router` ä¹‹åæ³¨å†Œï¼Œå®ƒè¦†ç›–äº† `/api/v1/agents` è·¯å¾„ï¼Œå¯¼è‡´åªæœ‰ `GET` æ–¹æ³•å¯ç”¨ã€‚

### 2. å‡½æ•°å‘½åå†²çªé—®é¢˜

**é—®é¢˜æè¿°ï¼š**
åœ¨ `agent_api.py` ä¸­ï¼Œå‡½æ•°åä¸å¯¼å…¥çš„å‡½æ•°åå†²çªã€‚

**å†²çªä»£ç ï¼š**
```python
from src.common.database.database_model import AgentRecord, AgentTemplates, create_agent_template

# å‡½æ•°åå†²çª
@router.post("/templates", response_model=AgentTemplateInfo)
async def create_agent_template(request_data: AgentTemplateCreateRequest, current_user=Depends(get_current_user)):
    # å†…éƒ¨è°ƒç”¨ create_agent_template å‡½æ•°ï¼Œä½†å‡½æ•°åå†²çª
    template = create_agent_template(...)  # è¿™é‡Œå®é™…è°ƒç”¨çš„æ˜¯è‡ªèº«ï¼Œè€Œä¸æ˜¯å¯¼å…¥çš„å‡½æ•°
```

### 3. å¯¼å…¥ç¼ºå¤±é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
åœ¨ `chat_api_v2.py` ä¸­ç¼ºå°‘å¿…è¦çš„å¯¼å…¥ã€‚

**ç¼ºå¤±å¯¼å…¥ï¼š**
- `logger` - æ—¥å¿—è®°å½•å™¨
- `DoesNotExist` - æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸å¤„ç†

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤è·¯ç”±å†²çª

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/api/routes/chat_api.py`

**ä¿®æ”¹å†…å®¹ï¼š**
```python
# ä¿®æ”¹å‰
@router.get("/agents")
@api_endpoint(require_tenant=False)
async def get_agents(...):

# ä¿®æ”¹å  
@router.get("/chat-agents")
@api_endpoint(require_tenant=False)
async def get_agents(...):
```

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/api/routes/chat_api_v2.py`

**ä¿®æ”¹å†…å®¹ï¼š**
```python
# ä¿®æ”¹å‰
@router.get("/agents")
@api_endpoint(require_tenant=False)
async def get_agents_v2(...):

# ä¿®æ”¹å
@router.get("/chat-agents")
@api_endpoint(require_tenant=False)
async def get_agents_v2(...):
```

### 2. ä¿®å¤å‡½æ•°å‘½åå†²çª

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/api/routes/agent_api.py`

**ä¿®æ”¹å†…å®¹ï¼š**
```python
# ä¿®æ”¹å‰
@router.post("/templates", response_model=AgentTemplateInfo)
async def create_agent_template(...):

# ä¿®æ”¹å
@router.post("/templates", response_model=AgentTemplateInfo)
async def create_agent_template_api(...):
```

### 3. ä¿®å¤å¯¼å…¥ç¼ºå¤±

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/api/routes/chat_api_v2.py`

**ä¿®æ”¹å†…å®¹ï¼š**
```python
# æ·»åŠ ç¼ºå¤±çš„å¯¼å…¥
from peewee import DoesNotExist
from src.common.logger import get_logger

logger = get_logger(__name__)
```

## æŠ€æœ¯ç»†èŠ‚

### è·¯ç”±å†²çªåŸç†

åœ¨FastAPIä¸­ï¼Œå½“å¤šä¸ªè·¯ç”±å™¨æ³¨å†Œç›¸åŒçš„è·¯å¾„æ—¶ï¼š
- åæ³¨å†Œçš„è·¯ç”±å™¨ä¼šè¦†ç›–å…ˆæ³¨å†Œçš„è·¯ç”±å™¨
- å¦‚æœä¸¤ä¸ªè·¯ç”±å™¨éƒ½å®šä¹‰äº†ç›¸åŒè·¯å¾„çš„ä¸åŒæ–¹æ³•ï¼Œåªæœ‰åæ³¨å†Œçš„è·¯ç”±å™¨çš„æ–¹æ³•ä¼šç”Ÿæ•ˆ
- åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œ`chat_router` åªå®šä¹‰äº† `GET /agents`ï¼Œè¦†ç›–äº† `agent_router` çš„æ‰€æœ‰æ–¹æ³•

### å‡½æ•°å‘½åå†²çªåŸç†

Pythonçš„ä½œç”¨åŸŸè§„åˆ™ï¼š
- å±€éƒ¨å˜é‡ï¼ˆåŒ…æ‹¬å‡½æ•°å‚æ•°ï¼‰ä¼˜å…ˆäºå…¨å±€å˜é‡
- å½“å‡½æ•°åä¸å¯¼å…¥çš„å‡½æ•°åç›¸åŒæ—¶ï¼Œå‡½æ•°å†…éƒ¨æ— æ³•è®¿é—®å¯¼å…¥çš„å‡½æ•°
- è¿™å¯¼è‡´é€’å½’è°ƒç”¨è‡ªèº«è€Œä¸æ˜¯è°ƒç”¨é¢„æœŸçš„å¯¼å…¥å‡½æ•°

## éªŒè¯ç»“æœ

### APIè·¯ç”±éªŒè¯

**ä¿®å¤åçš„è·¯ç”±ç»“æ„ï¼š**
```
/api/v1/agents/           # Agentç®¡ç†API (GET, POST, PUT, DELETE)
/api/v1/agents/{agent_id} # å•ä¸ªAgentæ“ä½œ
/api/v1/agents/templates  # Agentæ¨¡æ¿ç®¡ç†
/api/v1/chat-agents       # èŠå¤©ç›¸å…³çš„Agentåˆ—è¡¨ (GET)
/api/v2/chat-agents       # V2èŠå¤©ç›¸å…³çš„Agentåˆ—è¡¨ (GET)
```

### åŠŸèƒ½éªŒè¯

1. **Agentåˆ›å»º** - æˆåŠŸåˆ›å»ºAgentå¹¶è¿”å›æ­£ç¡®çš„Agent ID
2. **Agentåˆ—è¡¨** - æˆåŠŸè·å–ç§Ÿæˆ·çš„Agentåˆ—è¡¨
3. **Agentæ¨¡æ¿** - æ­£å¸¸è·å–å’Œåˆ›å»ºAgentæ¨¡æ¿
4. **èŠå¤©åŠŸèƒ½** - èŠå¤©APIæ­£å¸¸å·¥ä½œï¼ˆé™¤å‚æ•°éªŒè¯å¤–ï¼‰

## æ›´æ”¹åå¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜

### 1. API å…¼å®¹æ€§é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
è·¯å¾„ä¿®æ”¹å¯èƒ½å¯¼è‡´ç°æœ‰å®¢æˆ·ç«¯ä»£ç å¤±æ•ˆã€‚

**å…·ä½“å½±å“ï¼š**
- ä½¿ç”¨ `/api/v1/agents` è·å–èŠå¤©ç›¸å…³Agentåˆ—è¡¨çš„å®¢æˆ·ç«¯ä»£ç éœ€è¦æ›´æ–°ä¸º `/api/v1/chat-agents`
- ä½¿ç”¨ `/api/v2/agents` è·å–èŠå¤©ç›¸å…³Agentåˆ—è¡¨çš„å®¢æˆ·ç«¯ä»£ç éœ€è¦æ›´æ–°ä¸º `/api/v2/chat-agents`

**ç¼“è§£æªæ–½ï¼š**
- æä¾›å‘åå…¼å®¹çš„APIç«¯ç‚¹ï¼ˆå¦‚æœå¿…è¦ï¼‰
- æ›´æ–°APIæ–‡æ¡£å’Œå®¢æˆ·ç«¯SDK
- é€šçŸ¥æ‰€æœ‰é›†æˆæ–¹è¿›è¡Œç›¸åº”çš„ä»£ç æ›´æ–°

### 2. æ–‡æ¡£åŒæ­¥é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
APIæ–‡æ¡£å¯èƒ½æ²¡æœ‰åŠæ—¶æ›´æ–°æ–°çš„è·¯å¾„ã€‚

**å…·ä½“å½±å“ï¼š**
- OpenAPIæ–‡æ¡£éœ€è¦æ›´æ–°æ–°çš„è·¯å¾„å®šä¹‰
- å¼€å‘è€…æ–‡æ¡£éœ€è¦åæ˜ è·¯å¾„å˜æ›´
- ç¤ºä¾‹ä»£ç å’Œæ•™ç¨‹éœ€è¦æ›´æ–°

**ç¼“è§£æªæ–½ï¼š**
- é‡æ–°ç”ŸæˆOpenAPIæ–‡æ¡£
- æ›´æ–°æ‰€æœ‰ç›¸å…³çš„å¼€å‘è€…æ–‡æ¡£
- åœ¨å˜æ›´æ—¥å¿—ä¸­è®°å½•APIè·¯å¾„å˜æ›´

### 3. æµ‹è¯•è¦†ç›–é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
ç°æœ‰çš„æµ‹è¯•ç”¨ä¾‹å¯èƒ½æ²¡æœ‰è¦†ç›–æ–°çš„è·¯å¾„ã€‚

**å…·ä½“å½±å“ï¼š**
- å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•éœ€è¦æ›´æ–°è·¯å¾„
- ç«¯åˆ°ç«¯æµ‹è¯•å¯èƒ½éœ€è¦è°ƒæ•´
- æ€§èƒ½æµ‹è¯•å’Œè´Ÿè½½æµ‹è¯•éœ€è¦éªŒè¯æ–°è·¯å¾„

**ç¼“è§£æªæ–½ï¼š**
- æ›´æ–°æ‰€æœ‰ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹
- ç¡®ä¿æ–°çš„è·¯å¾„æœ‰å……åˆ†çš„æµ‹è¯•è¦†ç›–
- è¿è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•å¥—ä»¶

### 4. ç›‘æ§å’Œæ—¥å¿—é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
ç›‘æ§ç³»ç»Ÿå’Œæ—¥å¿—åˆ†æå¯èƒ½éœ€è¦é€‚åº”æ–°çš„è·¯å¾„ã€‚

**å…·ä½“å½±å“ï¼š**
- ç›‘æ§ä»ªè¡¨æ¿ä¸­çš„è·¯å¾„ç»Ÿè®¡éœ€è¦æ›´æ–°
- æ—¥å¿—åˆ†æè§„åˆ™éœ€è¦è°ƒæ•´
- å‘Šè­¦è§„åˆ™å¯èƒ½éœ€è¦ä¿®æ”¹

**ç¼“è§£æªæ–½ï¼š**
- æ›´æ–°ç›‘æ§ç³»ç»Ÿçš„è·¯å¾„é…ç½®
- è°ƒæ•´æ—¥å¿—åˆ†æè§„åˆ™
- éªŒè¯å‘Šè­¦ç³»ç»Ÿæ­£å¸¸å·¥ä½œ

## é¢„é˜²æªæ–½

### ä»£ç å®¡æŸ¥å»ºè®®

1. **è·¯ç”±å‘½åè§„èŒƒ**ï¼š
   - é¿å…åœ¨ä¸åŒæ¨¡å—ä¸­ä½¿ç”¨ç›¸åŒçš„åŸºç¡€è·¯å¾„
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„è·¯å¾„å‰ç¼€åŒºåˆ†åŠŸèƒ½æ¨¡å—

2. **å‡½æ•°å‘½åè§„èŒƒ**ï¼š
   - é¿å…å‡½æ•°åä¸å¯¼å…¥åå†²çª
   - ä½¿ç”¨æè¿°æ€§çš„å‡½æ•°å

3. **å¯¼å…¥æ£€æŸ¥**ï¼š
   - ç¡®ä¿æ‰€æœ‰ä½¿ç”¨çš„æ¨¡å—éƒ½å·²æ­£ç¡®å¯¼å…¥
   - ä½¿ç”¨IDEçš„é™æ€åˆ†æå·¥å…·æ£€æŸ¥å¯¼å…¥é—®é¢˜

### æµ‹è¯•ç­–ç•¥

1. **è·¯ç”±å†²çªæµ‹è¯•**ï¼š
   - åœ¨é›†æˆæµ‹è¯•ä¸­éªŒè¯æ‰€æœ‰è·¯ç”±æ–¹æ³•
   - æ£€æŸ¥OpenAPIæ–‡æ¡£ç¡®ä¿æ‰€æœ‰é¢„æœŸæ–¹æ³•éƒ½å·²æ³¨å†Œ

2. **åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•**ï¼š
   - å®Œæ•´çš„APIé›†æˆæµ‹è¯•è¦†ç›–æ‰€æœ‰å…³é”®åŠŸèƒ½
   - è‡ªåŠ¨åŒ–æµ‹è¯•ç¡®ä¿ä¿®å¤ä¸ä¼šå¼•å…¥å›å½’é—®é¢˜

## æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜åˆ†æå’Œé’ˆå¯¹æ€§çš„ä¿®å¤ï¼ŒæˆåŠŸè§£å†³äº†MaiMBot APIæœåŠ¡å™¨ä¸­çš„Agentç®¡ç†åŠŸèƒ½é—®é¢˜ã€‚ä¸»è¦æˆæœï¼š

- âœ… è¯†åˆ«å¹¶ä¿®å¤äº†è·¯ç”±å†²çªé—®é¢˜
- âœ… è§£å†³äº†å‡½æ•°å‘½åå†²çªé—®é¢˜  
- âœ… è¡¥å……äº†ç¼ºå¤±çš„å¯¼å…¥
- âœ… æ¢å¤äº†å®Œæ•´çš„Agentç®¡ç†åŠŸèƒ½
- âœ… å»ºç«‹äº†é¢„é˜²ç±»ä¼¼é—®é¢˜çš„ä»£ç è§„èŒƒ

ç°åœ¨MaiMBotçš„APIæœåŠ¡å™¨æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½æ­£å¸¸å·¥ä½œï¼Œä¸ºåç»­å¼€å‘å’Œä½¿ç”¨æä¾›äº†ç¨³å®šçš„åŸºç¡€ã€‚
